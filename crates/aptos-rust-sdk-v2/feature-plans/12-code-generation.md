# Feature Plan: Code Generation from ABI

## Overview

Generate type-safe Rust code from Move module ABIs, enabling compile-time verification of contract interactions.

## Status: ✅ Implemented

## Goals

1. **Type Safety** - Generate Rust code that catches contract interaction errors at compile time
2. **Ergonomics** - Provide a natural Rust API that feels idiomatic
3. **Flexibility** - Support multiple generation modes (async/sync, selective features)
4. **CLI Tool** - Provide a command-line interface for easy code generation
5. **Move Source Integration** - Parse Move source files for better parameter names and documentation

## Design

### Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Code Generation                       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────────┐    ┌──────────────┐    ┌────────────┐ │
│  │    ABI      │───>│  Generator   │───>│   Rust     │ │
│  │   (JSON)    │    │   Engine     │    │   Code     │ │
│  └─────────────┘    └──────────────┘    └────────────┘ │
│         │                  │                            │
│         │           ┌──────┴──────┐                     │
│         │           │             │                     │
│         v           v             v                     │
│  ┌─────────────┐ ┌─────────┐ ┌─────────┐               │
│  │   Type      │ │  Entry  │ │  View   │               │
│  │   Mapper    │ │  Funcs  │ │  Funcs  │               │
│  └─────────────┘ └─────────┘ └─────────┘               │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### Type Mapping

Move types are mapped to Rust types:

| Move Type | Rust Type |
|-----------|-----------|
| `bool` | `bool` |
| `u8`, `u16`, `u32`, `u64`, `u128` | `u8`, `u16`, `u32`, `u64`, `u128` |
| `u256` | `U256` |
| `address` | `AccountAddress` |
| `&signer` | (excluded from params) |
| `vector<u8>` | `Vec<u8>` |
| `vector<T>` | `Vec<T>` |
| `0x1::string::String` | `String` |
| `0x1::option::Option<T>` | `Option<T>` |
| `0x1::object::Object<T>` | `AccountAddress` |
| Custom structs | Generated struct |

### Generated Code Structure

```rust
//! Generated Rust bindings for `0xcafe::my_token`.
//!
//! This file was auto-generated by aptos-rust-sdk-v2 codegen.
//! Do not edit manually.

use aptos_rust_sdk_v2::{...};

// Constants
pub const MODULE_ADDRESS: &str = "0xcafe";
pub const MODULE_NAME: &str = "my_token";

// Struct Definitions
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct TokenInfo {
    pub name: String,
    pub symbol: String,
    pub decimals: u8,
}

// Entry Functions
pub fn transfer(
    recipient: AccountAddress,
    amount: u64,
) -> AptosResult<TransactionPayload> {
    // ... implementation
}

// View Functions
pub async fn view_balance(
    aptos: &Aptos,
    owner: AccountAddress,
) -> AptosResult<Vec<serde_json::Value>> {
    // ... implementation
}
```

## API

### Library Usage

```rust
use aptos_rust_sdk_v2::codegen::{GeneratorConfig, ModuleGenerator};

// Load ABI
let abi: MoveModuleABI = serde_json::from_str(&abi_json)?;

// Configure generator
let config = GeneratorConfig::new()
    .with_entry_functions(true)
    .with_view_functions(true)
    .with_structs(true)
    .with_async(true);

// Generate code
let generator = ModuleGenerator::new(&abi, config);
let code = generator.generate()?;

// Write to file
std::fs::write("src/generated/my_module.rs", &code)?;
```

### With Move Source (Recommended)

```rust
use aptos_rust_sdk_v2::codegen::{GeneratorConfig, ModuleGenerator, MoveSourceParser};

// Load ABI
let abi: MoveModuleABI = serde_json::from_str(&abi_json)?;

// Parse Move source for better parameter names and docs
let move_source = std::fs::read_to_string("sources/my_module.move")?;
let source_info = MoveSourceParser::parse(&move_source);

// Generate with enriched information
let generator = ModuleGenerator::new(&abi, GeneratorConfig::default())
    .with_source_info(source_info);
let code = generator.generate()?;

// Result: Functions have real parameter names (recipient, amount) 
// instead of generic (arg0, arg1) and include documentation
```

### CLI Usage

```bash
# From local ABI file
aptos-codegen --input module_abi.json --output src/generated/

# With Move source for better parameter names
aptos-codegen --input module_abi.json --source my_module.move --output src/generated/

# From on-chain module
aptos-codegen --module 0x1::coin --network testnet --output src/generated/

# With options
aptos-codegen --input abi.json --output src/ \
    --module-name custom_name \
    --source my_module.move \
    --sync \
    --no-structs
```

### CLI Options

| Option | Description |
|--------|-------------|
| `--input, -i` | Path to local ABI JSON file |
| `--module, -m` | On-chain module (format: `address::name`) |
| `--network, -n` | Network for on-chain fetch (mainnet/testnet/devnet/local) |
| `--source, -s` | Path to Move source file for parameter names and docs |
| `--output, -o` | Output directory |
| `--module-name` | Custom name for generated module |
| `--sync` | Generate synchronous functions |
| `--no-entry-functions` | Skip entry function generation |
| `--no-view-functions` | Skip view function generation |
| `--no-structs` | Skip struct generation |
| `--builder` | Use builder pattern for entry functions |

## Implementation

### Files

- `src/codegen/mod.rs` - Module exports
- `src/codegen/types.rs` - Move to Rust type mapping
- `src/codegen/generator.rs` - Code generation engine
- `src/bin/codegen.rs` - CLI binary

### GeneratorConfig

```rust
pub struct GeneratorConfig {
    pub module_name: Option<String>,
    pub generate_entry_functions: bool,
    pub generate_view_functions: bool,
    pub generate_structs: bool,
    pub async_functions: bool,
    pub type_mapper: MoveTypeMapper,
    pub include_address_constant: bool,
    pub use_builder_pattern: bool,
}
```

### MoveTypeMapper

```rust
pub struct MoveTypeMapper {
    custom_mappings: HashMap<String, RustType>,
}

impl MoveTypeMapper {
    pub fn map_type(&self, move_type: &str) -> RustType;
    pub fn to_bcs_arg(&self, move_type: &str, var_name: &str) -> String;
    pub fn is_signer_param(&self, move_type: &str) -> bool;
}
```

## Features

### Entry Function Generation

- Excludes `&signer` parameters (automatically set to sender)
- BCS-encodes all arguments
- Supports type arguments for generic functions
- Returns `AptosResult<TransactionPayload>`

### View Function Generation

- Generates async functions by default
- JSON-encodes arguments for view calls
- Supports type arguments
- Returns `AptosResult<Vec<serde_json::Value>>`

### Struct Generation

- Derives `Debug`, `Clone`, `PartialEq`, `Serialize`, `Deserialize`
- Handles generic type parameters
- Maps field names to snake_case
- Handles Rust reserved keywords (`type` → `r#type`)

## Testing

```rust
#[test]
fn test_generate_entry_function() {
    let abi = sample_abi();
    let generator = ModuleGenerator::new(&abi, GeneratorConfig::default());
    let code = generator.generate().unwrap();
    
    assert!(code.contains("pub fn transfer"));
    assert!(code.contains("arg0: AccountAddress"));
    assert!(!code.contains("signer")); // excluded
}

#[test]
fn test_generate_view_function() {
    let abi = sample_abi();
    let generator = ModuleGenerator::new(&abi, GeneratorConfig::default());
    let code = generator.generate().unwrap();
    
    assert!(code.contains("pub async fn view_balance"));
}
```

## Future Enhancements

1. **Build-time generation** - Proc macro for compile-time codegen
2. **Type-safe returns** - Parse view function returns into typed structs
3. **Event parsing** - Generate event struct definitions
4. **Module caching** - Cache ABI fetches for faster rebuilds
5. **Incremental generation** - Only regenerate changed modules

